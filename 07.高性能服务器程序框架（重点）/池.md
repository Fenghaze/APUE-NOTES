# 池

==池是一组资源的集合，这组资源在服务器启动之初就被完全创建好并初始化，这称为静态资源分配==

通常会预先分配一定的资源，此后如果发现资源不够用时，再动态分配一些并加入到池中

**优点：**

- 减少了分配系统资源的时间
- 避免了服务器对内核的频繁访问



池中的资源主要有两类：

- 需要系统调用的系统资源

- 需要网络通信的远程资源, 如数据库连接、套接字连接、线程和内存分配等等



池实现的方法：

- 将资源存放在数组、链表、队列等数据结构中
- 使用设计模式中的==单例模式==设计池的类，保证一个程序只有一个类实例



# 进程池

进程池与线程池类似，下面以进程池为例进行介绍



进程池：由服务器预先创建的一组子进程

静态进程池：创建固定数量的子进程，一般在3~10个之间；线程池中的线程数和CPU核数差不多

动态进程池：有下限和上限，会因为客户端的数量在区间内动态扩张/缩减（定义步长）

- 什么时候扩张/缩减？单独用一个线程来管理
- 定义两个变量：当前存活的进程数、当前运行的进程数；根据比例来进行扩张/缩减



当新的任务到来时，主进程将通过以下两种方式让进程池中的子进程来执行任务：

- 方法一：**主进程使用某种算法来主动选择子进程**，如随机算法、轮流选取算法

- 方法二：**主进程和进程池共享一个工作队列**，子进程都睡眠在该工作队列上；当有新的任务到来时，主进程将这个客户端添加到队列，然后==唤醒==正在等待任务的子进程，进程池中的所有子进程都会来抢这个任务进行处理，但只有一个子进程能抢到这个任务，其他子进程将继续等待任务

  - 任务队列是临界资源，需要互斥锁

    任务队列的情况：

    - 任务队列为空：进程池等待阻塞（直到任务队列有任务才开始取任务）
    - 任务队列满：服务端等待阻塞（直到任务队列不满才开始接收客户端的新任务）

当选择好子进程后，主进程需要通过某种**通知机制**来告诉该子进程来执行任务，并传递要处理的数据。最简单的办法是在父进程和该子进程直接创建一个==管道==，来实现进程间通信；线程间通信时，可以将共享的数据定义为全局变量，这是线程共享的

![](D:\mynotes\APUE-NOTES\07.高性能服务器程序框架（重点）\assets\进程池模型.png)

# 线程池

线程池主要用于：

- （1）需要大量的线程来完成任务，且完成任务的时间比较短。 比如WEB服务器完成网页请求这样的任务，使用线程池技术是非常合适的。因为单个任务小，而任务数量巨大。但对于长时间的任务，比如一个Telnet连接请求，线程池的优点就不明显了。因为Telnet会话时间比线程的创建时间大多了
- （2）对性能要求苛刻的应用，比如要求服务器迅速响应客户请求
- （3）接受突发性的大量请求，但不至于使服务器因此产生大量线程的应用。



线程池使用中需要注意的问题:

- 创建太多的线程会浪费资源
- 关注创建了但未使用的线程
- 销毁了大量线程后又花费较多的时间来重新创建它们
- 创建线程过于缓慢可能导致客户端性能变差
- 销毁线程过于缓慢可能会饿死其他的处理流程



# 内存池

内存池是一种内存分配方式。通常我们习惯直接使用new、malloc等系统调用申请分配内存，这样做的**缺点在于：由于所申请内存块的大小不定，当频繁使用时会造成大量的内存碎片并进而降低性能。**

内存池则是在真正使用内存之前，先==申请分配一定数量的、大小相等(一般情况下)的内存块留作备用==。当有新的内存需求时，就从内存池中分出一部分内存块，若内存块不够再继续申请新的内存。这样做的一个显著优点是，使得内存分配效率得到提升。



对于内存池的应用而言，可以通过以下方式分配、访问和释放内存:

- 从池中分配内存时，函数将确定所需块的池。如果该池的所有区块已被保留，则该函数试图在下一个较大的池中找到一个。分配的内存块用句柄表示
- 获取分配内存的访问指针
- **释放以前分配的内存块**



**内存池将句柄划分为池索引、内存块索引以及版本, 从而在内部解释句柄。池和内存块索引允许使用句柄快速访问对应的块, 而在每个新分配中增量的版本允许检测已经释放内存块的句柄。**

内存池允许使用恒定的执行时间来分配内存。数千个对象在池中的内存释放只是一个操作, 而不是一个一个的Free。内存池也可以采用树状结构, 应用于特殊的编程行为, 如循环，递归等。固定大小的块内存池不需要为每个块分配元数据存储, 不需要描述分配块的大小等特性。

内存池还可用于对象, 在这种情况下,对象本身没有外部资源, 只占用内存, 已经创建了的对象避免了对象创建时的内存分配。当对象创建成本较高时, 对象池是有用的, 但在某些情况下, 这种简单的对象池可能并不有效, 实际上还可能会降低性能。



# 连接池

在各种连接池的实现中，常用的参数一般有：连接数，连接时间，有效性。

**连接数：**

设计一个连接池，要确定池中的连接数量，包括最小空闲连接数，最大空闲连接数，连接池最大持有连接数。当然连接数可以变化，动态缩放，确定每次增加／减少的连接数量。

**有效性：**

增加“心跳检测”来保证连接池中的连接具有有效性。

**连接时间：**

为了保持池中连接的有效性，空闲连接检测时间也就是心跳间隔，这往往取决于业务使用连接池的场景。另外，还有从连接池中获取连接的最大等待时间，一般地默认为-1，即无可用连接会抛出异常，当设为0时表示无穷大。



## TCP连接池

TCP连接池主要节省创建TCP连接的时间，从而降低了请求的总处理时间。

客户端为每个服务端实例维护一个连接池。如果连接池中有空闲连接，则复用这个连接。如果连接池中没有空闲连接，则会建立一个新的TCP连接或者等待池中出现空闲的连接。当客户端使用池中连接处理完一个请求时，如果连接池中的空闲连接数小于连接池的大小，则将当前使用的连接放入连接池。 如果连接池中的空闲连接数大于等于连接池的大小，则关闭当前使用的连接。

面向http短连接的连接池，服务端支持keepalive时才有效，如果服务端关闭keepalive，则效果等同于短连接，就没有连接池的作用了。**同理，如果连接池的大小设置为0，也等同于短连接的方式。**服务端支持Keepalive的时候，可以减少CPU和内存的使用，允许请求和应答的HTTP管道化，减少了后续请求的延迟，报告错误也无需关闭TCP连接。

**一般地，对于延迟敏感的业务，可以使用连接池机制。**



## 数据库连接池

数据库连接池中的**资源为一组数据库连接**，由程序动态地对池中的连接进行使用，释放，可以理解为维护数据库连接的缓存, 以便在需要对数据库的请求时可以重用连接

一般的，为每个用户打开和维护数据库连接需要消耗大量的资源，而数据库连接池用于提高数据库中执行命令的性能，减少了用户必须等待的时间。在数据库连接池中, 创建连接后将其放入池中, 再次使用, 不必重新建立新的连接。如果所有的连接都被使用, 则创建新的连接并被添加到池中。



**应用：**

基于 web 的应用程序和企业应用程序一般都使用应用服务器来处理连接池。当页面需要访问数据库时, 只需使用池中的现有连接, 并且只在池中没有空闲连接的情况下建立新连接。这减少了连接到数据库响应单个请求的开销，需要频繁访问数据库的本地应用程序也可以从数据库连接池中受益。
