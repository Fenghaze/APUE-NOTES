# 协议

双方交换数据（通信）的规则



# 分层模型

OSI参考模型（自底向上）：

物理层、数据链路层；网络层；传输层；会话层、表示层、应用层

TCP/IP模型（自底向上）：

网络接口层（链路层）；网络层；传输层；应用层



操作系统做的事：

发送端：将数据按照分层模型自顶向下的协议进行打包

接收端：将数据按照分层模型自底向上的协议进行解包



**打包**：网络接口层（链路层）协议（网络层协议（传输层协议==（应用层协议（数据==

对于操作系统而言，对数据进行打包时也有用户的参与（其中应用层协议的封装是在User态完成的），外面三层协议的封装是在Kernel态完成的

应用层协议：如HTTP协议



**拆包**：因为数据是要打包之后才能在网络中传输的，且数据受到多个层协议的影响，不可能将数据一次性打包，因此需要对数据进行拆包传输

如：

数据60000kb，经过多层封装后，最外层的网络接口层的协议（以太网帧）允许传输最大字节数为1500

因此需要将数据进行拆分，拆成60000/1500=40个包进行封装再传输



# 路由器寻路

两端进行通信时，中途会经过许多路由器

经过的每个路由器称为路由节点

每个路由器都有一个路由表，路由表记录了该路由器能到达的下一个路由节点地址



# 以太网帧

以太网帧是链路层封装的协议

数据包是依据MAC地址（MAC地址唯一）来进行传输的

```
目的地址|当前地址|帧类型|发送的数据
```

目的地址：下一跳的MAC（网卡）地址，一开始不知道，需要发送ARP请求来获得

源地址：当前的MAC地址

==帧类型==：0800（发送普通数据）、0806（发送ARP请求，获取下一个节点的MAC地址）



## ARP 数据报

```
目的MAC|当前MAC|帧类型|...|当前MAC|当前IP|目的MAC|目的IP
```

作用：获取下一跳的MAC地址



数据包在网络传输的过程中会经过一个一个的路由节点，是如何找到到达目的地所需要经过的路由节点？

实际上，数据包不是只打包一次解包一次的

数据包想要达到下一个路由节点（下一跳）时，一开始是不知道这个路由器的MAC地址的

因此需要对**链路层和网络层进行解包**

网络层解包：获得了==当前IP地址==和最终要到达的==目的地IP地址==

当前路由器参照路由表，路由表中记录了到达目的地IP地址所经过的==下一跳路由器IP地址==

链路层解包：获得了==当前MAC地址==

于是再将==当前IP地址==、==当前MAC地址==和==下一跳的IP地址==打包起来，并向路由表中的所有路由器发送一个ARP请求

目标路由器接收到ARP请求，将自己的MAC地址进行补充，然后又按照自身的路由表发送一个ARP请求

此时发送端接收到这个ARP请求，获得了下一个路由节点的MAC地址后，就可以将这个MAC地址填充到以太网帧中，进行正常的网络传输

简单来说，发送端到接收端中途会经过许多路由器，每要到达下一个路由器，都需要对数据包的链路层和网络层进行一次解包，从而获得下一个路由器的MAC地址，再将数据包发送给这个路由器，以此类推，最终到达接收端



==注意！！！==

- 以太网帧和ARP数据报中的源MAC和目的MAC是指当前的MAC和下一跳的MAC，它们负责找到传输路径
- 真正的目的地IP是封装在网络层的IP协议中的



# IP

IP协议是网络层协议

IP段的长度是32位（4字节）

4位版本、8位生存实践

32位源IP：发送端IP

32位目的IP：接收端IP



# TCP/UDP

TCP/UDP协议是传输层协议

发送端到接收端，不光要指定IP地址，还要指定端口号，以确保两端正确通信

端口号是在传输层指定的



## UDP

```
16位源端口号|16位目的端口号
```



## TCP

```
16位源端口号|16位目的端口号
32位序号
32位确认序号
```



## TCP 状态转换图

查看TCP状态命令：`netstat -apn | gerp 端口号`

LISTEN：监听

ESTABLISHED：连接建立成功

FIN_WAIT2：（主动发起关闭的一方）半关闭

TIME_WAIT：等待2MSL再全关闭（在等待时间内，端口还没关闭）



# 网络层与传输层

网络层与硬件联系紧密，网络传输会不稳定

传输层：对网络层进行弥补

- 完全不弥补UDP：无连接不可靠报文传输
- 完全弥补TCP：面向连接的可靠数据包传输



# TCP异常断开：心跳检测机制

作用：用于检测客户端和服务器之间是否仍然保持连接



服务器和客户端之间有一个心跳包（应用层实现）：**固定的频率**来发送标志位，类似网络层的协议

乒乓包：类似于心跳包，但是可以携带简单数据